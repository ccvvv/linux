#!/usr/bin/env bash
#############################################
tmoe_main() {
	case "$1" in
	p* | proot)
		source_tmoe_env
		TMOE_CHROOT=false
		;;
	c* | chroot)
		source_tmoe_env
		TMOE_CHROOT=true
		;;
	systemd | sd | systemctl | ns | nspawn)
		source_tmoe_env
		SYSTEMD_NSPAWN=true
		TMOE_CHROOT=true
		;;
	ls)
		check_manager_dir
		bash ${MANAGER_DIR}/share/container/debian/lnk-menu
		exit 0
		;;
	zsh)
		zsh-i
		exit 0
		;;
	theme)
		zshtheme
		exit 0
		;;
	aria2)
		aria2-i
		exit 0
		;;
	i | -i)
		debian-i
		exit 0
		;;
	m | manager | "")
		check_manager_dir
		bash ${MANAGER_DIR}/manager.sh
		exit 0
		;;
	t | tool)
		check_manager_dir
		if [[ $(uname -o) = Android ]]; then
			bash ${MANAGER_DIR}/manager.sh
		else
			bash ${MANAGER_DIR}/tool.sh
		fi
		exit 0
		;;
	-h* | --h* | *)
		cat <<-EOF
			ls         --list installed containers
			m          --tmoe manager
			t          --tmoe tool
			p          --proot
			c          --chroot
			aria2      --aria2 manager
			theme      --zshtheme
			zsh        --zsh manager
		EOF
		printf "%s\n" "You can go to the git repository for help information"
		exit 0
		;;
	esac
	case "$2" in
	a | arch) DISTRO_NAME='arch' ;;
	al | ap | alpine) DISTRO_NAME='alpine' ;;
	arm | armbian) DISTRO_NAME='armbian' ;;
	c | ce | cent | centos) DISTRO_NAME='centos' ;;
	d | deb | debian) DISTRO_NAME='debian' ;;
	dde | deepin) DISTRO_NAME='deepin' ;;
	devuan) DISTRO_NAME='devuan' ;;
	f | fe | fedora) DISTRO_NAME='fedora' ;;
	ft | funtoo) DISTRO_NAME='funtoo' ;;
	g | gt | gentoo) DISTRO_NAME='gentoo' ;;
	k | kali) DISTRO_NAME='kali' ;;
	mi | mint) DISTRO_NAME='mint' ;;
	m | mj | mjr | manjaro) DISTRO_NAME='manjaro' ;;
	o | suse | opensuse) DISTRO_NAME='opensuse' ;;
	ow | wrt | openwrt) DISTRO_NAME='openwrt' ;;
	r | rasp | raspios) DISTRO_NAME='raspios' ;;
	raspbian) DISTRO_NAME='raspios' ;;
	s | sl | slackware) DISTRO_NAME='slackware' ;;
	u | ub* | ubuntu) DISTRO_NAME='ubuntu' ;;
	v | void) DISTRO_NAME='void' ;;
	vnc) EXEC_PROGRAM='startvnc' ;;
	xs | xsdl | xserver) EXEC_PROGRAM='startxsdl' ;;
	x11 | x11vnc) EXEC_PROGRAM='startx11vnc' ;;
	no | novnc) EXEC_PROGRAM='novnc' ;;
	*) DISTRO_NAME="$2" ;;
	esac
	case "$3" in
	20.10) DISTRO_CODE='groovy' ;;
	21.04) DISTRO_CODE='hirsute' ;;
	20.04) DISTRO_CODE='focal' ;;
	18.04) DISTRO_CODE='bionic' ;;
	al | ap) DISTRO_CODE="alpine" ;; #This is not DISTRO_NAME
	8s) DISTRO_CODE='8-Stream' ;;
	9s) DISTRO_CODE='9-Stream' ;;
	s) DISTRO_CODE='sid' ;;
	r | ro) DISTRO_CODE='rolling' ;;
	raw) DISTRO_CODE='rawhide' ;;
	n | none) DISTRO_CODE='' ;;
	x | amd64 | x64) ARCH_TYPE='amd64' ;;
	a | aarch64 | arm64) ARCH_TYPE='arm64' ;;
	h | arm | armhf) ARCH_TYPE='armhf' ;;
	armel) ARCH_TYPE='armel' ;;
	i | i386 | x86 | x32) ARCH_TYPE='i386' ;;
	p | ppc) ARCH_TYPE='ppc64el' ;;
	s390x) ARCH_TYPE='s390x' ;;
	m | mips | mipsel) ARCH_TYPE='mipsel' ;;
	m64 | mips64 | mips64el) ARCH_TYPE='mips64el' ;;
	risc*) ARCH_TYPE='riscv64' ;;
	v | vnc) EXEC_PROGRAM='tigervnc' ;;
	xs | xsdl | xserver) EXEC_PROGRAM='xserver' ;;
	x11 | x11vnc) EXEC_PROGRAM='x11vnc' ;;
	no | novnc) EXEC_PROGRAM='novnc' ;;
	bash) TMOE_SHELL='/bin/bash' ;;
	ash) TMOE_SHELL='/bin/ash' ;;
	zs) TMOE_SHELL='/bin/zsh' ;;
	z | zsh) DISTRO_CODE="zsh" ;;
	*) DISTRO_CODE="$3" ;;
	esac

	case "$4" in
	x | amd64 | x64) ARCH_TYPE='amd64' ;;
	a | aarch* | arm64) ARCH_TYPE='arm64' ;;
	h | arm | armhf) ARCH_TYPE='armhf' ;;
	armel) ARCH_TYPE='armel' ;;
	i | i386 | x86 | x32) ARCH_TYPE='i386' ;;
	p | ppc*) ARCH_TYPE='ppc64el' ;;
	s390*) ARCH_TYPE='s390x' ;;
	m | mips | mipsel) ARCH_TYPE='mipsel' ;;
	m64 | mips64 | mips64el) ARCH_TYPE='mips64el' ;;
	risc*) ARCH_TYPE='riscv64' ;;
	v | vnc) EXEC_PROGRAM='startvnc' ;;
	xs | xsdl | xserver) EXEC_PROGRAM='startxsdl' ;;
	x11 | x11vnc) EXEC_PROGRAM='startx11vnc' ;;
	no | novnc) EXEC_PROGRAM='novnc' ;;
	bash) TMOE_SHELL='/bin/bash' ;;
	z | zsh) TMOE_SHELL='/bin/zsh' ;;
	ash) TMOE_SHELL='/bin/ash' ;;
	*) EXEC_PROGRAM="${4}" ;;
	esac
	case "$5" in
	v | vnc) EXEC_PROGRAM='startvnc' ;;
	x | xs | xsdl | xserver) EXEC_PROGRAM='startxsdl' ;;
	x11 | x11vnc) EXEC_PROGRAM='startx11vnc' ;;
	no | novnc) EXEC_PROGRAM='novnc' ;;
	bash) TMOE_SHELL='/bin/bash' ;;
	z | zsh) TMOE_SHELL='/bin/zsh' ;;
	ash) TMOE_SHELL='/bin/ash' ;;
	*/*) TEMPORARY_SCRIPT_FILE="${5}" ;;
	*) EXEC_PROGRAM="${5}" ;;
	esac
	TMOE_PARAMETERS="$*"
	start_tmoe_container
}
#############
check_manager_dir() {
	MANAGER_DIR_01="${HOME}/.local/share/tmoe-linux/git"
	MANAGER_DIR_02="/usr/local/etc/tmoe-linux/git"
	if [ -e "${MANAGER_DIR_01}" ]; then
		MANAGER_DIR=${MANAGER_DIR_01}
	else
		MANAGER_DIR=${MANAGER_DIR_02}
	fi
}
source_tmoe_env() {
	TMOE_CONTAINER_FORTUNE=true
	TMOE_CONTAINER_HITOKOTO=true
	CONFIG_FOLDER=${HOME}/.config/tmoe-linux
	source ${CONFIG_FOLDER}/hitokoto.conf 2>/dev/null
	case $(uname -o) in
	Android)
		TMOE_LINUX_DIR="${HOME}/.local/share/tmoe-linux"
		[[ ! $(command -v termux-wake-lock) ]] || termux-wake-lock 2>/dev/null
		;;
	*) TMOE_LINUX_DIR="/usr/local/etc/tmoe-linux" ;;
	esac
	case ${TMOE_CONTAINER_FORTUNE} in
	true)
		if [ $(command -v fortune) ]; then
			fortune 2>/dev/null
		elif [ -e /usr/games/fortune ]; then
			/usr/games/fortune 2>/dev/null
		fi
		;;
	esac
	TMOE_GIT_DIR="${TMOE_LINUX_DIR}/git"
	TMOE_SHARE_DIR="${TMOE_GIT_DIR}/share"
	TMOE_CONTAINER_DIR="${TMOE_LINUX_DIR}/containers"
	ENV_FILE="${TMOE_SHARE_DIR}/environment/manager_environment"
	source ${ENV_FILE}
	check_arch
	ACROSS_ARCH_FILE="${CONFIG_FOLDER}/across_architecture_container.txt"
	[[ ! -s "${ACROSS_ARCH_FILE}" ]] || ARCH_TYPE="$(head -n 1 ${ACROSS_ARCH_FILE})"
}
########
check_container_login_file_01() {
	if [ ! -e "${TMOE_GNU_LINUX_CONTAINER_ENV_DIR}/login" ]; then
		${TMOE_PREFIX} mkdir -pv ${TMOE_GNU_LINUX_CONTAINER_ENV_DIR} ${DEBIAN_CHROOT}/etc/profile.d/permanent ${DEBIAN_CHROOT}/etc/profile.d/temporary
		${TMOE_PREFIX} cp -fv ${TMOE_SHARE_DIR}/container/profile/login ${TMOE_GNU_LINUX_CONTAINER_ENV_DIR}
		${TMOE_PREFIX} cp -fv ${TMOE_SHARE_DIR}/container/profile/login ${DEBIAN_CHROOT}/etc/profile.d/001_login.sh
		${TMOE_PREFIX} chmod -Rv 755 ${TMOE_GNU_LINUX_CONTAINER_ENV_DIR} ${DEBIAN_CHROOT}/etc/profile.d/001_login.sh ${DEBIAN_CHROOT}/etc/profile.d/permanent ${DEBIAN_CHROOT}/etc/profile.d/temporary
	fi
	if [[ ! -e ${CONTAINER_ZLOGIN_FILE} ]]; then
		${TMOE_PREFIX} mkdir -pv ${CONTAINER_ZSH_DIR}
		${TMOE_PREFIX} cp -fv ${TMOE_SHARE_DIR}/container/profile/zlogin ${CONTAINER_ZLOGIN_FILE}
		${TMOE_PREFIX} chmod -Rv 755 ${CONTAINER_ZSH_DIR}
	elif ! grep -q 'environment/login' ${CONTAINER_ZLOGIN_FILE}; then
		${TMOE_PREFIX} sed -i '$ a[[ ! -r /usr/local/etc/tmoe-linux/environment/login ]] || source /usr/local/etc/tmoe-linux/environment/login' ${CONTAINER_ZLOGIN_FILE}
	fi
}
########
create_and_move_temporary_script_01() {
	if [[ -n ${EXEC_PROGRAM} ]]; then
		printf "%s\n" "${EXEC_PROGRAM}" >${TMPDIR}/.tmoe_temporary_autostartup_script
	else
		printf "%s\n" "${TEMPORARY_SCRIPT_FILE}" >${TMPDIR}/.tmoe_temporary_autostartup_script
	fi
	cat ${TMPDIR}/.tmoe_temporary_autostartup_script
	${TMOE_PREFIX} chmod 777 ${TMPDIR}/.tmoe_temporary_autostartup_script
	${TMOE_PREFIX} mv -f ${TMPDIR}/.tmoe_temporary_autostartup_script "${TMOE_GNU_LINUX_CONTAINER_TEMPORARY_STARTUP_DIR}/startvnc"
}
start_tmoe_container() {
	DEFAULT_SHELL_CONF=${CONFIG_FOLDER}/default_shell.conf
	case ${TMOE_SHELL} in
	"") rm -f ${DEFAULT_SHELL_CONF} 2>/dev/null ;;
	*) printf "%s\n" "TMOE_SHELL=${TMOE_SHELL}" >${DEFAULT_SHELL_CONF} ;;
	esac
	if [[ $(command -v pulseaudio) && $(id -u) != 0 ]]; then
		pulseaudio --start
	fi
	case "${DISTRO_NAME}" in
	"") ;;
	*)
		case ${DISTRO_CODE} in
		"") DEBIAN_FOLDER=${DISTRO_NAME}_${ARCH_TYPE} ;;
		*) DEBIAN_FOLDER=${DISTRO_NAME}-${DISTRO_CODE}_${ARCH_TYPE} ;;
		esac
		;;
	esac
	tmoe_env_02 #source DEBIAN_CHROOT以及其它变量
	if [ -e ${DEBIAN_CHROOT}/etc/os-release ]; then
		grep 'PRETTY_NAME' ${DEBIAN_CHROOT}/etc/os-release 2>/dev/null | awk -F '"' '{print $2}'
	else
		sed -n p ${DEBIAN_CHROOT}/etc/issue 2>/dev/null
	fi
	case ${TMOE_CONTAINER_HITOKOTO} in
	true) [[ ! ${TMOE_LANG} =~ zh_.*UTF-8 ]] || get_hitokito_cn ;;
	esac

	if [[ -n ${EXEC_PROGRAM} ]]; then
		case ${EXEC_PROGRAM} in
		startx11vnc | startvnc) [[ ! $(command -v am) ]] || am start -n com.realvnc.viewer.android/com.realvnc.viewer.android.app.ConnectionChooserActivity 2>/dev/null ;;
		novnc)
			NOVNC_PORT=$(grep '^NOVNC_PORT=' ${DEBIAN_CHROOT}/usr/local/bin/novnc | head -n 1 | awk -F '=' '{print $2}' | cut -d '"' -f 2)
			[[ -n ${NOVNC_PORT} ]] || NOVNC_PORT=36080
			NOVNC_ADDR="http://localhost:${NOVNC_PORT}/vnc.html"
			printf "${YELLOW}%s${RESET}\n" "${NOVNC_ADDR}"
			if [[ $(command -v am) ]]; then
				am start -a android.intent.action.VIEW -d "${NOVNC_ADDR}" 2>/dev/null
			elif [[ $(command -v xdg-open) ]]; then
				xdg-open ${NOVNC_ADDR} 2>/dev/null
			elif [[ -e /mnt/c/WINDOWS/system32/cmd.exe ]]; then
				cd /mnt/c/Users
				/mnt/c/WINDOWS/system32/cmd.exe /c "start ${NOVNC_ADDR}"
				cd -
			fi
			;;
		startxsdl)
			[[ ! $(command -v am) ]] || am start -n x.org.server/x.org.server.MainActivity 2>/dev/null
			printf "%s\n" "Please wait 9s."
			#sleep 9
			#此处不要sleep
			;;
		esac
		check_container_login_file_01
		create_and_move_temporary_script_01
	fi
	if [[ -n ${TEMPORARY_SCRIPT_FILE} ]]; then
		check_container_login_file_01
		if [[ -e ${TEMPORARY_SCRIPT_FILE} ]]; then
			${TMOE_PREFIX} cp -vf "${TEMPORARY_SCRIPT_FILE}" "${TMOE_GNU_LINUX_CONTAINER_TEMPORARY_STARTUP_DIR}"
		else
			create_and_move_temporary_script_01
		fi
	fi
	case ${SYSTEMD_NSPAWN} in
	true)
		case $(uname -o) in
		Android)
			printf "%s\n" "Sorry,this feature does not support ${PURPLE}Android${RESET} system."
			printf "${YELLOW}%s\n" "如需运行systemd容器，请换用${BLUE}GNU/Linux${RESET}系统。"
			exit 1
			;;
		esac
		case $(id -u) in
		0)
			source ${TMOE_SHARE_DIR}/removal/umount
			source ${TMOE_SHARE_DIR}/container/nspawn/startup
			;;
		*)
			sudo -E tmoe ${TMOE_PARAMETERS}
			exit 1
			;;
		esac
		;;
	*) ${TMOE_PREFIX} bash ${TMOE_GNU_LINUX_CONTAINER_STARTUP_FILE} ;;
	esac
}
##########
tmoe_main "$@"
